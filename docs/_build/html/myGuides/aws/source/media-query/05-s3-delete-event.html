


<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  
  <title>Part 5: Add S3 delete event handler &mdash; all-knowledge</title>
  
  <link rel="icon" type="image/png" sizes="32x32" href="../../../../_static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../../_static/icons/favicon-16x16.png">
  <link rel="manifest" href="../../../../_static/icons/site.webmanifest">
  <link rel="mask-icon" href="../../../../_static/icons/safari-pinned-tab.svg" color="#919191">
  <meta name="msapplication-TileColor" content="#2b5797">
  <meta name="msapplication-config" content="../../../../_static/icons/browserconfig.xml">
  <link rel="stylesheet" href="../../../../_static/stylesheets/examples.css">
  <link rel="stylesheet" href="../../../../_static/stylesheets/deprecation.css">

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster.custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster.bundle.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-shadow.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-punk.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-noir.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-light.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-borderless.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/micromodal.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/sphinx_rtd_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="https://pandemic-overview.readthedocs.io/en/latest/myGuides/aws/source/media-query/05-s3-delete-event.html" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/js/hoverxref.js"></script>
        <script src="../../../../_static/js/tooltipster.bundle.min.js"></script>
        <script src="../../../../_static/js/micromodal.min.js"></script>
        <script src="../../../../_static/tabs.js"></script>
        <script src="../../../../_static/js/expand_tabs.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Part 6: Add REST API to query media files" href="06-web-api.html" />
    <link rel="prev" title="Part 4: Add S3 event source" href="04-s3-event.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/statsmodels-logo-v2-bw.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Covid-Medical-Treatments/Covid-Medical-Treatments.html">Covid Medical Treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Bill-Gates-Memes/Bill-Gates-Memes.html">Bill Gates Memes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/topics.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Data-science-of-the-pandemic/Data-science-of-the-pandemic.html">Data Science of the Pandemic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Vaccines/Vaccines.html">Vaccines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Masks/Masks.html">Masks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Lockdowns/Lockdowns.html">Lockdowns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Origins-of-the-Virus/Origins-of-the-Virus.html">Origins of the Virus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Preparedness/Pandemic-Preparedness.html">Pandemic Preparedness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Participants/Pandemic-Participants.html">Pandemic Participants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Food-Safety/Food-Safety.html">Food Safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Municipal-Matters/Municipal-Matters.html">Municipal Issues and Topics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Tech-stack-for-this-website.html">Tech stack for this website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../myGuides.html">My Guides for Various Technical Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../General-computer-setup.html">General Computer Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Advanced-Computer-Setup.html">Advanced Computer Setup and Topics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">AWS Chalice Workshop</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../env-setup.html">Prerequisite: Setting up your environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../todo-app/index.html">Todo Application</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">Media Query Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/media-query/final/README.html">Media Query Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/final/README.html">My Todo App</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part1/README.html">Chalice Workshop Code Part 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part2/README.html">Chalice Workshop Part 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ToDo-project-tasks.html">ToDo project and documentation tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Contribute.html">Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Upcoming-software-to-try.html">Links of Upcoming Software to Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Links-to-add-to-site.html">Links to add to the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Future-topics-to-be-developed.html">Future Topics to be developed</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sandbox/Sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../License/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Help-about/help.html">Help - About</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Covid-Medical-Treatments/Covid-Medical-Treatments.html">Covid Medical Treatments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Bill-Gates-Memes/Bill-Gates-Memes.html">Bill Gates Memes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/topics.html">Topics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Data-science-of-the-pandemic/Data-science-of-the-pandemic.html">Data Science of the Pandemic</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Vaccines/Vaccines.html">Vaccines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Masks/Masks.html">Masks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Lockdowns/Lockdowns.html">Lockdowns</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Origins-of-the-Virus/Origins-of-the-Virus.html">Origins of the Virus</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Preparedness/Pandemic-Preparedness.html">Pandemic Preparedness</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Participants/Pandemic-Participants.html">Pandemic Participants</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Food-Safety/Food-Safety.html">Food Safety</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Municipal-Matters/Municipal-Matters.html">Municipal Issues and Topics</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Tech-stack-for-this-website.html">Tech stack for this website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../myGuides.html">My Guides for Various Technical Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../General-computer-setup.html">General Computer Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Advanced-Computer-Setup.html">Advanced Computer Setup and Topics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">AWS Chalice Workshop</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../env-setup.html">Prerequisite: Setting up your environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../todo-app/index.html">Todo Application</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">Media Query Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/media-query/final/README.html">Media Query Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/final/README.html">My Todo App</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part1/README.html">Chalice Workshop Code Part 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part2/README.html">Chalice Workshop Part 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ToDo-project-tasks.html">ToDo project and documentation tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Contribute.html">Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Upcoming-software-to-try.html">Links of Upcoming Software to Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Links-to-add-to-site.html">Links to add to the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Future-topics-to-be-developed.html">Future Topics to be developed</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">all-knowledge</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a> &raquo;</li>
        
          <li><a href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a> &raquo;</li>
        
          <li><a href="../index.html">AWS Chalice Workshop</a> &raquo;</li>
        
          <li><a href="index.html">Media Query Application</a> &raquo;</li>
        
      <li>Part 5: Add S3 delete event handler</li>
    
    
    <li class="wy-breadcrumbs-aside">
    
        
        <a href="../../../../_sources/myGuides/aws/source/media-query/05-s3-delete-event.rst.txt" rel="nofollow"> View page source</a>
        
    
    </li>

  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="06-web-api.html" class="btn btn-neutral float-right" title="Part 6: Add REST API to query media files" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="04-s3-event.html" class="btn btn-neutral float-left" title="Part 4: Add S3 event source" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <section id="part-5-add-s3-delete-event-handler">
<h1>Part 5: Add S3 delete event handler<a class="headerlink" href="#part-5-add-s3-delete-event-handler" title="Permalink to this headline">¶</a></h1>
<p>Now that we are automatically importing uploaded images to our table, we need
to be able to automatically delete images from our table that get deleted
from our bucket. This can be accomplished by doing the following:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#add-lambda-function-for-s3-object-deletion" id="id3">Add Lambda function for S3 object deletion</a></p></li>
<li><p><a class="reference internal" href="#redeploy-the-chalice-application" id="id4">Redeploy the Chalice application</a></p></li>
</ul>
</div>
<section id="add-lambda-function-for-s3-object-deletion">
<h2><a class="toc-backref" href="#id3">Add Lambda function for S3 object deletion</a><a class="headerlink" href="#add-lambda-function-for-s3-object-deletion" title="Permalink to this headline">¶</a></h2>
<p>Add a new Lambda function that is invoked whenever an object is deleted from
the S3 bucket and if it is an image, removes the image from the table.</p>
<section id="instructions">
<h3>Instructions<a class="headerlink" href="#instructions" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file add a new function <code class="docutils literal notranslate"><span class="pre">handle_object_removed</span></code> that
is triggered whenever an object gets deleted from the bucket and
deletes the item from table if it is an image:</p></li>
</ol>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectRemoved:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_removed</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_media_file</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="verification">
<h3>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Ensure the contents of the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file is:</p></li>
</ol>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">Chalice</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">rekognition</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Chalice</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s1">&#39;media-query&#39;</span><span class="p">)</span>

<span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;.png&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_media_db</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_MEDIA_DB</span>
    <span class="k">if</span> <span class="n">_MEDIA_DB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DynamoMediaDB</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_TABLE_NAME&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_MEDIA_DB</span>


<span class="k">def</span> <span class="nf">get_rekognition_client</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_REKOGNITION_CLIENT</span>
    <span class="k">if</span> <span class="n">_REKOGNITION_CLIENT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="n">rekognition</span><span class="o">.</span><span class="n">RekognitonClient</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;rekognition&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_REKOGNITION_CLIENT</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectCreated:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_created</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectRemoved:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_removed</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_media_file</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_is_image</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_rekognition_client</span><span class="p">()</span><span class="o">.</span><span class="n">get_image_labels</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">add_media_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">IMAGE_TYPE</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</section>
</section>
<section id="redeploy-the-chalice-application">
<h2><a class="toc-backref" href="#id4">Redeploy the Chalice application</a><a class="headerlink" href="#redeploy-the-chalice-application" title="Permalink to this headline">¶</a></h2>
<p>Deploy the updated Chalice application with the new Lambda function.</p>
<section id="id1">
<h3>Instructions<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice deploy
Creating IAM role: media-query-dev-handle_object_removed
Creating lambda function: media-query-dev-handle_object_removed
Configuring S3 events in bucket media-query-mediabucket-fb8oddjbslv1 to function media-query-dev-handle_object_removed
Resources deployed:
  - Lambda ARN: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_created
  - Lambda ARN: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_removed
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id2">
<h3>Verification<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Delete the uploaded <code class="docutils literal notranslate"><span class="pre">othersample.jpg</span></code> object from the previous part:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws s3 rm s3://$MEDIA_BUCKET_NAME/othersample.jpg
</pre></div>
</div>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">scan</span></code> CLI command to ensure the object is no longer in the
table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws dynamodb scan --table-name $MEDIA_TABLE_NAME
{
    &quot;Items&quot;: [
        {
            &quot;name&quot;: {
                &quot;S&quot;: &quot;sample.jpg&quot;
            },
            &quot;labels&quot;: {
                &quot;L&quot;: [
                    {
                        &quot;S&quot;: &quot;Animal&quot;
                    },
                    {
                        &quot;S&quot;: &quot;Canine&quot;
                    },
                    {
                        &quot;S&quot;: &quot;Dog&quot;
                    },
                    {
                        &quot;S&quot;: &quot;German Shepherd&quot;
                    },
                    {
                        &quot;S&quot;: &quot;Mammal&quot;
                    },
                    {
                        &quot;S&quot;: &quot;Pet&quot;
                    },
                    {
                        &quot;S&quot;: &quot;Collie&quot;
                    }
                ]
            },
            &quot;type&quot;: {
                &quot;S&quot;: &quot;image&quot;
            }
        }
    ],
    &quot;Count&quot;: 1,
    &quot;ScannedCount&quot;: 1,
    &quot;ConsumedCapacity&quot;: null
}
</pre></div>
</div>
<p>If the item still appears, try running the <code class="docutils literal notranslate"><span class="pre">scan</span></code> command after
waiting for ten seconds. Sometimes, it takes a little bit of time for the
Lambda function to get triggered. In the end, the table should only have the
<code class="docutils literal notranslate"><span class="pre">sample.jpg</span></code> item.</p>
</li>
</ol>
</section>
</section>
</section>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="06-web-api.html" class="btn btn-neutral float-right" title="Part 6: Add REST API to query media files" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="04-s3-event.html" class="btn btn-neutral float-left" title="Part 4: Add S3 event source" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2021, Thomas Connors and Contributors.
      <span class="lastupdated">
        Last updated on Sat, 17 Jul 2021 12:00 AM .
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>