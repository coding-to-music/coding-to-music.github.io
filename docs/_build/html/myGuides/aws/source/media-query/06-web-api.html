

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Part 6: Add REST API to query media files &mdash; all-knowledge</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster.custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster.bundle.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-shadow.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-punk.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-noir.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-light.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/tooltipster-sideTip-borderless.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/micromodal.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/custom.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/tabs.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/sphinx_rtd_theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/contentui.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/gallery-rendered-html.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/css/lightbox.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
  

  
  

  
    <link rel="canonical" href="https://pandemic-overview.readthedocs.io/en/latest/myGuides/aws/source/media-query/06-web-api.html" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script src="../../../../_static/js/hoverxref.js"></script>
        <script src="../../../../_static/js/tooltipster.bundle.min.js"></script>
        <script src="../../../../_static/js/micromodal.min.js"></script>
        <script src="../../../../_static/tabs.js"></script>
        <script src="../../../../_static/js/expand_tabs.js"></script>
        <script src="../../../../_static/contentui.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/jquery-1.11.0.min.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2/js/lightbox.min.js"></script>
        <script src="../../../../_static/sphinxcontrib-images/LightBox2/lightbox2-customize/jquery-noconflict.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Part 7: Add workflow to process videos" href="07-videos.html" />
    <link rel="prev" title="Part 5: Add S3 delete event handler" href="05-s3-delete-event.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html">
          

          
            
            <img src="../../../../_static/statsmodels-logo-v2-bw.svg" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Covid-Medical-Treatments/Covid-Medical-Treatments.html">Covid Medical Treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Bill-Gates-Memes/Bill-Gates-Memes.html">Bill Gates Memes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/topics.html">Topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Data-science-of-the-pandemic/Data-science-of-the-pandemic.html">Data Science of the Pandemic</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Vaccines/Vaccines.html">Vaccines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Masks/Masks.html">Masks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Lockdowns/Lockdowns.html">Lockdowns</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Origins-of-the-Virus/Origins-of-the-Virus.html">Origins of the Virus</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Preparedness/Pandemic-Preparedness.html">Pandemic Preparedness</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Participants/Pandemic-Participants.html">Pandemic Participants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Food-Safety/Food-Safety.html">Food Safety</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Municipal-Matters/Municipal-Matters.html">Municipal Issues and Topics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Tech-stack-for-this-website.html">Tech stack for this website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../myGuides.html">My Guides for Various Technical Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../General-computer-setup.html">General Computer Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Advanced-Computer-Setup.html">Advanced Computer Setup and Topics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">AWS Chalice Workshop</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../env-setup.html">Prerequisite: Setting up your environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../todo-app/index.html">Todo Application</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">Media Query Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/media-query/final/README.html">Media Query Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/final/README.html">My Todo App</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part1/README.html">Chalice Workshop Code Part 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part2/README.html">Chalice Workshop Part 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ToDo-project-tasks.html">ToDo project and documentation tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Contribute.html">Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Upcoming-software-to-try.html">Links of Upcoming Software to Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Links-to-add-to-site.html">Links to add to the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Future-topics-to-be-developed.html">Future Topics to be developed</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Sandbox/Sandbox.html">Sandbox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../License/license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../Help-about/help.html">Help - About</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Covid-Medical-Treatments/Covid-Medical-Treatments.html">Covid Medical Treatments</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Bill-Gates-Memes/Bill-Gates-Memes.html">Bill Gates Memes</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/topics.html">Topics</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Data-science-of-the-pandemic/Data-science-of-the-pandemic.html">Data Science of the Pandemic</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Vaccines/Vaccines.html">Vaccines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Masks/Masks.html">Masks</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Lockdowns/Lockdowns.html">Lockdowns</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Origins-of-the-Virus/Origins-of-the-Virus.html">Origins of the Virus</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Preparedness/Pandemic-Preparedness.html">Pandemic Preparedness</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Pandemic-Participants/Pandemic-Participants.html">Pandemic Participants</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Food-Safety/Food-Safety.html">Food Safety</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../topics/Municipal-Matters/Municipal-Matters.html">Municipal Issues and Topics</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../Tech-stack-for-this-website.html">Tech stack for this website</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../myGuides.html">My Guides for Various Technical Topics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../General-computer-setup.html">General Computer Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Advanced-Computer-Setup.html">Advanced Computer Setup and Topics</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="../index.html">AWS Chalice Workshop</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="../env-setup.html">Prerequisite: Setting up your environment</a></li>
<li class="toctree-l4"><a class="reference internal" href="../todo-app/index.html">Todo Application</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="index.html">Media Query Application</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/media-query/final/README.html">Media Query Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/final/README.html">My Todo App</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part1/README.html">Chalice Workshop Code Part 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../code/todo-app/part2/README.html">Chalice Workshop Part 2</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../ToDo-project-tasks.html">ToDo project and documentation tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Contribute.html">Contribute</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../Upcoming-software-to-try.html">Links of Upcoming Software to Try</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Links-to-add-to-site.html">Links to add to the documentation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../How-you-can-help/Future-topics-to-be-developed.html">Future Topics to be developed</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">all-knowledge</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../../How-you-can-help/How-you-can-help.html">How you can help</a> &raquo;</li>
        
          <li><a href="../../Amazon-AWS-Learning.html">Amazon AWS Learning</a> &raquo;</li>
        
          <li><a href="../index.html">AWS Chalice Workshop</a> &raquo;</li>
        
          <li><a href="index.html">Media Query Application</a> &raquo;</li>
        
      <li>Part 6: Add REST API to query media files</li>
    
    
    <li class="wy-breadcrumbs-aside">
    
        
        
            <a href="https://github.com/coding-to-music/coding-to-music//master/source/myGuides/aws/source/media-query/06-web-api.rst" class="btn btn-neutral" title="Edit Page on GitHub" rel="Edit Page on GitHub"><span style="padding-left: 0.5em" >Edit on<i style="margin-left: 0.5em" class="fa fa-github"></i></span></a>
            <a href="https://github.com/coding-to-music/coding-to-music/commits/master/source/myGuides/aws/source/media-query/06-web-api.rst" class="btn btn-neutral" title="Page History" rel="Page History"><span class="fa fa-clock-o"></span></a>
            <a href="https://github.com/coding-to-music/coding-to-music/blame/master/source/myGuides/aws/source/media-query/06-web-api.rst" class="btn btn-neutral" title="Page Contributors" rel="Page Contributors"><span class="fa fa-users"></span></a>
        
        
    
    </li>

  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="07-videos.html" class="btn btn-neutral float-right" title="Part 7: Add workflow to process videos" accesskey="n">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
      
      
        <a href="05-s3-delete-event.html" class="btn btn-neutral float-left" title="Part 5: Add S3 delete event handler" accesskey="p"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
<div itemprop="articleBody">

<nav id="local-table-of-contents" role="navigation" aria-labelledby="local-table-of-contents-title">
    <h4 id="local-table-of-contents-title">On This Page</h4>
    <ul>
<li><a class="reference internal" href="#">Part 6: Add REST API to query media files</a><ul>
<li><a class="reference internal" href="#add-route-for-listing-media-items">Add route for listing media items</a><ul>
<li><a class="reference internal" href="#instructions">Instructions</a></li>
<li><a class="reference internal" href="#verification">Verification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#add-route-for-retrieving-a-single-media-item">Add route for retrieving a single media item</a><ul>
<li><a class="reference internal" href="#id1">Instructions</a></li>
<li><a class="reference internal" href="#id2">Verification</a></li>
</ul>
</li>
<li><a class="reference internal" href="#redeploy-the-chalice-application">Redeploy the Chalice application</a><ul>
<li><a class="reference internal" href="#id3">Instructions</a></li>
<li><a class="reference internal" href="#id4">Verification</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</nav>


  <section id="part-6-add-rest-api-to-query-media-files">
<h1>Part 6: Add REST API to query media files<a class="headerlink" href="#part-6-add-rest-api-to-query-media-files" title="Permalink to this headline">¶</a></h1>
<p>So far we have been querying the image files stored in our table via the AWS
CLI. However, it would be more helpful to have an API on-top of the table
instead of having to query it directly with the AWS CLI. We will now use Amazon
API Gateway integrations with Lambda to create an API for our application.
This API will have two routes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/</span></code> - List all media items in the table. You can supply the query
string parameters: <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">media-type</span></code>, and <code class="docutils literal notranslate"><span class="pre">label</span></code> to further
filter the media items returned in the API call</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/{name}</span></code> - Retrieve the media item based on the <code class="docutils literal notranslate"><span class="pre">name</span></code> of the media
item.</p></li>
</ul>
<p>To create this API, we will perform the following steps:</p>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#add-route-for-listing-media-items" id="id5">Add route for listing media items</a></p></li>
<li><p><a class="reference internal" href="#add-route-for-retrieving-a-single-media-item" id="id6">Add route for retrieving a single media item</a></p></li>
<li><p><a class="reference internal" href="#redeploy-the-chalice-application" id="id7">Redeploy the Chalice application</a></p></li>
</ul>
</div>
<section id="add-route-for-listing-media-items">
<h2><a class="toc-backref" href="#id5">Add route for listing media items</a><a class="headerlink" href="#add-route-for-listing-media-items" title="Permalink to this headline">¶</a></h2>
<p>Add an API route <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/</span></code> that lists all items in the table and allows
users to query on <code class="docutils literal notranslate"><span class="pre">startswith</span></code>, <code class="docutils literal notranslate"><span class="pre">media-type</span></code>, and <code class="docutils literal notranslate"><span class="pre">label</span></code>.</p>
<section id="instructions">
<h3>Instructions<a class="headerlink" href="#instructions" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file, define the function <code class="docutils literal notranslate"><span class="pre">list_media_files()</span></code> that
has the route <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/</span></code> using the
<a class="reference external" href="https://chalice.readthedocs.io/en/latest/api.html#Chalice.route">app.route</a>
decorator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_media_files</span><span class="p">():</span>
</pre></div>
</div>
</li>
<li><p>Inside of the <code class="docutils literal notranslate"><span class="pre">list_media_files()</span></code> function, extract the query string
parameters from the
<a class="reference external" href="https://chalice.readthedocs.io/en/latest/api.html#Request">app.current_request</a>
object and query the database for the media files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_media_files</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_extract_db_list_params</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_media_files</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_extract_db_list_params</span><span class="p">(</span><span class="n">query_params</span><span class="p">):</span>
    <span class="n">valid_query_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;startswith&#39;</span><span class="p">,</span>
        <span class="s1">&#39;media-type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_query_params</span>
    <span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="verification">
<h3>Verification<a class="headerlink" href="#verification" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Ensure the contents of the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file is:</p></li>
</ol>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">Chalice</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">rekognition</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Chalice</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s1">&#39;media-query&#39;</span><span class="p">)</span>

<span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;.png&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_media_db</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_MEDIA_DB</span>
    <span class="k">if</span> <span class="n">_MEDIA_DB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DynamoMediaDB</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_TABLE_NAME&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_MEDIA_DB</span>


<span class="k">def</span> <span class="nf">get_rekognition_client</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_REKOGNITION_CLIENT</span>
    <span class="k">if</span> <span class="n">_REKOGNITION_CLIENT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="n">rekognition</span><span class="o">.</span><span class="n">RekognitonClient</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;rekognition&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_REKOGNITION_CLIENT</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectCreated:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_created</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectRemoved:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_removed</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_media_file</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_media_files</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_extract_db_list_params</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_media_files</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_extract_db_list_params</span><span class="p">(</span><span class="n">query_params</span><span class="p">):</span>
    <span class="n">valid_query_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;startswith&#39;</span><span class="p">,</span>
        <span class="s1">&#39;media-type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_query_params</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_is_image</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_rekognition_client</span><span class="p">()</span><span class="o">.</span><span class="n">get_image_labels</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">add_media_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">IMAGE_TYPE</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<ol class="arabic" start="2">
<li><p>Install <a class="reference external" href="https://httpie.org/">HTTPie</a> to query the API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ pip install httpie
</pre></div>
</div>
</li>
<li><p>In a different terminal, run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">local</span></code> to run the API as a server
locally:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice local
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the API for all images:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http 127.0.0.1:8000/
HTTP/1.1 200 OK
Content-Length: 126
Content-Type: application/json
Date: Tue, 17 Jul 2018 13:59:35 GMT
Server: BaseHTTP/0.6 Python/3.6.1

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the API using the query string parameter <code class="docutils literal notranslate"><span class="pre">label</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http 127.0.0.1:8000/ label==Dog
HTTP/1.1 200 OK
Content-Length: 126
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:01:22 GMT
Server: BaseHTTP/0.6 Python/3.6.1

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]
$ http 127.0.0.1:8000/ label==Person
HTTP/1.1 200 OK
Content-Length: 2
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:01:46 GMT
Server: BaseHTTP/0.6 Python/3.6.1

[]
</pre></div>
</div>
<p>Feel free to test out any of the other query string parameters as well.</p>
</li>
</ol>
</section>
</section>
<section id="add-route-for-retrieving-a-single-media-item">
<h2><a class="toc-backref" href="#id6">Add route for retrieving a single media item</a><a class="headerlink" href="#add-route-for-retrieving-a-single-media-item" title="Permalink to this headline">¶</a></h2>
<p>Add an API route <code class="docutils literal notranslate"><span class="pre">GET</span> <span class="pre">/{name}</span></code> that retrieves a single item in the table
using the <code class="docutils literal notranslate"><span class="pre">name</span></code> of the item.</p>
<section id="id1">
<h3>Instructions<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Import <code class="docutils literal notranslate"><span class="pre">chalice.NotFoundError</span></code> in the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file:</p></li>
</ol>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span>
<span class="normal">6</span>
<span class="normal">7</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">Chalice</span>
<span class="hll"><span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">NotFoundError</span>
</span><span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">rekognition</span>
</pre></div>
</td></tr></table></div>
<ol class="arabic" start="2">
<li><p>In the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file, define the function <code class="docutils literal notranslate"><span class="pre">get_media_file()</span></code> decorated
by <code class="docutils literal notranslate"><span class="pre">app.route('/{name}')</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</pre></div>
</div>
</li>
<li><p>Within the <code class="docutils literal notranslate"><span class="pre">get_media_file()</span></code> function, query the media item using the
<code class="docutils literal notranslate"><span class="pre">name</span></code> parameter and raise a <code class="docutils literal notranslate"><span class="pre">chalice.NotFoundError</span></code> exception when the
<code class="docutils literal notranslate"><span class="pre">name</span></code> does not exist in the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="s1">&#39;Media file (</span><span class="si">%s</span><span class="s1">) not found&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">item</span>
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id2">
<h3>Verification<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li><p>Ensure the contents of the <code class="docutils literal notranslate"><span class="pre">app.py</span></code> file is:</p></li>
</ol>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span></pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">Chalice</span>
<span class="kn">from</span> <span class="nn">chalice</span> <span class="kn">import</span> <span class="n">NotFoundError</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">chalicelib</span> <span class="kn">import</span> <span class="n">rekognition</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Chalice</span><span class="p">(</span><span class="n">app_name</span><span class="o">=</span><span class="s1">&#39;media-query&#39;</span><span class="p">)</span>

<span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;.jpg&#39;</span><span class="p">,</span>
    <span class="s1">&#39;.png&#39;</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_media_db</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_MEDIA_DB</span>
    <span class="k">if</span> <span class="n">_MEDIA_DB</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_MEDIA_DB</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">DynamoMediaDB</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s1">&#39;dynamodb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_TABLE_NAME&#39;</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">_MEDIA_DB</span>


<span class="k">def</span> <span class="nf">get_rekognition_client</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_REKOGNITION_CLIENT</span>
    <span class="k">if</span> <span class="n">_REKOGNITION_CLIENT</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_REKOGNITION_CLIENT</span> <span class="o">=</span> <span class="n">rekognition</span><span class="o">.</span><span class="n">RekognitonClient</span><span class="p">(</span>
            <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s1">&#39;rekognition&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">_REKOGNITION_CLIENT</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectCreated:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_created</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">on_s3_event</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;MEDIA_BUCKET_NAME&#39;</span><span class="p">],</span>
                 <span class="n">events</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;s3:ObjectRemoved:*&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">handle_object_removed</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_is_image</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">):</span>
        <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">delete_media_file</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">list_media_files</span><span class="p">():</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">_extract_db_list_params</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">current_request</span><span class="o">.</span><span class="n">query_params</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">list_media_files</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/</span><span class="si">{name}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">get_media_file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NotFoundError</span><span class="p">(</span><span class="s1">&#39;Media file (</span><span class="si">%s</span><span class="s1">) not found&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">item</span>


<span class="k">def</span> <span class="nf">_extract_db_list_params</span><span class="p">(</span><span class="n">query_params</span><span class="p">):</span>
    <span class="n">valid_query_params</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;startswith&#39;</span><span class="p">,</span>
        <span class="s1">&#39;media-type&#39;</span><span class="p">,</span>
        <span class="s1">&#39;label&#39;</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span> <span class="n">v</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_query_params</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_is_image</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">_SUPPORTED_IMAGE_EXTENSIONS</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_handle_created_image</span><span class="p">(</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">get_rekognition_client</span><span class="p">()</span><span class="o">.</span><span class="n">get_image_labels</span><span class="p">(</span><span class="n">bucket</span><span class="o">=</span><span class="n">bucket</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
    <span class="n">get_media_db</span><span class="p">()</span><span class="o">.</span><span class="n">add_media_file</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">media_type</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">IMAGE_TYPE</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<ol class="arabic" start="2">
<li><p>If the local server is not still running, run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">local</span></code> to
restart the local API server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice local
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the API for the <code class="docutils literal notranslate"><span class="pre">sample.jpg</span></code> image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http 127.0.0.1:8000/sample.jpg
HTTP/1.1 200 OK
Content-Length: 124
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:09:01 GMT
Server: BaseHTTP/0.6 Python/3.6.1

{
    &quot;labels&quot;: [
        &quot;Animal&quot;,
        &quot;Canine&quot;,
        &quot;Dog&quot;,
        &quot;German Shepherd&quot;,
        &quot;Mammal&quot;,
        &quot;Pet&quot;,
        &quot;Collie&quot;
    ],
    &quot;name&quot;: &quot;sample.jpg&quot;,
    &quot;type&quot;: &quot;image&quot;
}
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the API for an image that does not exist:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http 127.0.0.1:8000/noexists.jpg
HTTP/1.1 404 Not Found
Content-Length: 90
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:09:34 GMT
Server: BaseHTTP/0.6 Python/3.6.1

{
    &quot;Code&quot;: &quot;NotFoundError&quot;,
    &quot;Message&quot;: &quot;NotFoundError: Media file (noexists.jpg) not found&quot;
}
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="redeploy-the-chalice-application">
<h2><a class="toc-backref" href="#id7">Redeploy the Chalice application</a><a class="headerlink" href="#redeploy-the-chalice-application" title="Permalink to this headline">¶</a></h2>
<p>Deploy the Chalice application based on the updates.</p>
<section id="id3">
<h3>Instructions<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Run <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">deploy</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ chalice deploy
Creating deployment package.
Updating policy for IAM role: media-query-dev-handle_object_created
Updating lambda function: media-query-dev-handle_object_created
Configuring S3 events in bucket media-query-mediabucket-fb8oddjbslv1 to function media-query-dev-handle_object_created
Updating policy for IAM role: media-query-dev-handle_object_removed
Updating lambda function: media-query-dev-handle_object_removed
Configuring S3 events in bucket media-query-mediabucket-fb8oddjbslv1 to function media-query-dev-handle_object_removed
Creating IAM role: media-query-dev-api_handler
Creating lambda function: media-query-dev
Creating Rest API
Resources deployed:
  - Lambda ARN: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_created
  - Lambda ARN: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev-handle_object_removed
  - Lambda ARN: arn:aws:lambda:us-west-2:123456789123:function:media-query-dev
  - Rest API URL: https://1lmxgj9bfl.execute-api.us-west-2.amazonaws.com/api/
</pre></div>
</div>
</li>
</ol>
</section>
<section id="id4">
<h3>Verification<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Reupload the <code class="docutils literal notranslate"><span class="pre">othersample.jpg</span></code> image using the CLI:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ aws s3 cp ../chalice-workshop/code/media-query/final/assets/othersample.jpg s3://$MEDIA_BUCKET_NAME
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the deployed API for all media items:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http $(chalice url)
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 126
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:14:27 GMT
Via: 1.1 a3c7cc30af6c8465e695a3c0d44793e0.cloudfront.net (CloudFront)
X-Amz-Cf-Id: PAkgH2j5G2er_TZwyQOcwGahwNTR8dhEhrCUklcdDuuEBcKOYQ1-Ug==
X-Amzn-Trace-Id: Root=1-5b4df9c1-89a47758a7a7989e47799a12;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: KLP2SFnTPHcFeqw=
x-amzn-RequestId: b5e7488a-89cb-11e8-acbf-eda14961f501

[
    {
        &quot;labels&quot;: [
            &quot;Human&quot;,
            &quot;People&quot;,
            &quot;Person&quot;,
            &quot;Phone Booth&quot;,
            &quot;Bus&quot;,
            &quot;Transportation&quot;,
            &quot;Vehicle&quot;,
            &quot;Man&quot;,
            &quot;Face&quot;,
            &quot;Leisure Activities&quot;,
            &quot;Tourist&quot;,
            &quot;Portrait&quot;,
            &quot;Crowd&quot;
        ],
        &quot;name&quot;: &quot;othersample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    },
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]
</pre></div>
</div>
<p>Note <code class="docutils literal notranslate"><span class="pre">chalice</span> <span class="pre">url</span></code> just returns the URL of the remotely deployed API.</p>
</li>
<li><p>Use HTTPie to test out a couple of the query string parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http $(chalice url) label==&#39;Phone Booth&#39;
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 207
Content-Type: application/json
Date: Sun, 22 Jul 2018 07:49:37 GMT
Via: 1.1 75fd15ce5d9f38e4c444039a1548df96.cloudfront.net (CloudFront)
X-Amz-Cf-Id: nYpeS8kk_lFklCA7wCkOI0NO1wabDI3jvs3UpHFlsJ-c0nvlXNrvJQ==
X-Amzn-Trace-Id: Root=1-5b543710-8beb4000395cd60e5688841a;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: Ka2KpF0nvHcF1hg=
x-amzn-RequestId: c7e9cabf-8d83-11e8-b109-5f2c96dac9da

[
    {
        &quot;labels&quot;: [
            &quot;Human&quot;,
            &quot;People&quot;,
            &quot;Person&quot;,
            &quot;Phone Booth&quot;,
            &quot;Bus&quot;,
            &quot;Transportation&quot;,
            &quot;Vehicle&quot;,
            &quot;Man&quot;,
            &quot;Face&quot;,
            &quot;Leisure Activities&quot;,
            &quot;Tourist&quot;,
            &quot;Portrait&quot;,
            &quot;Crowd&quot;
        ],
        &quot;name&quot;: &quot;othersample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]

$ http $(chalice url) startswith==sample
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 126
Content-Type: application/json
Date: Sun, 22 Jul 2018 07:51:03 GMT
Via: 1.1 53657f22d99084ad547a21392858391b.cloudfront.net (CloudFront)
X-Amz-Cf-Id: TORlA6wdOff5n4xHUH9ftnXNxFrTmQsSFG18acx7iwKLA_NsUoUoCg==
X-Amzn-Trace-Id: Root=1-5b543766-912f6e067cb58ddcb6a973de;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: Ka2YEGNvPHcF8SA=
x-amzn-RequestId: fb25c9e7-8d83-11e8-898d-8da83b49132b

[
    {
        &quot;labels&quot;: [
            &quot;Animal&quot;,
            &quot;Canine&quot;,
            &quot;Dog&quot;,
            &quot;German Shepherd&quot;,
            &quot;Mammal&quot;,
            &quot;Pet&quot;,
            &quot;Collie&quot;
        ],
        &quot;name&quot;: &quot;sample.jpg&quot;,
        &quot;type&quot;: &quot;image&quot;
    }
]
</pre></div>
</div>
</li>
<li><p>Use HTTPie to query the deployed API for <code class="docutils literal notranslate"><span class="pre">sample.jpg</span></code> image:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http $(chalice url)sample.jpg
HTTP/1.1 200 OK
Connection: keep-alive
Content-Length: 124
Content-Type: application/json
Date: Tue, 17 Jul 2018 14:16:04 GMT
Via: 1.1 7ca583dd6abc0b0f42b148142a75588a.cloudfront.net (CloudFront)
X-Amz-Cf-Id: pzkZ0uZvk5e5W-ZV39v2zCCFAmmRJjDMJZ_I9GyDKhg6WEHotrMmnQ==
X-Amzn-Trace-Id: Root=1-5b4dfa24-69d586d8e94fb75019b42f24;Sampled=0
X-Cache: Miss from cloudfront
x-amz-apigw-id: KLQFrF3svHcF32Q=
x-amzn-RequestId: f0a6a6af-89cb-11e8-8420-e7ec8398ed6b

{
    &quot;labels&quot;: [
        &quot;Animal&quot;,
        &quot;Canine&quot;,
        &quot;Dog&quot;,
        &quot;German Shepherd&quot;,
        &quot;Mammal&quot;,
        &quot;Pet&quot;,
        &quot;Collie&quot;
    ],
    &quot;name&quot;: &quot;sample.jpg&quot;,
    &quot;type&quot;: &quot;image&quot;
}
</pre></div>
</div>
</li>
</ol>
</section>
</section>
</section>


</div>

</div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="07-videos.html" class="btn btn-neutral float-right" title="Part 7: Add workflow to process videos" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="05-s3-delete-event.html" class="btn btn-neutral float-left" title="Part 5: Add S3 delete event handler" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020-2021, Thomas Connors and Contributors.
      <span class="lastupdated">
        Last updated on Sat, 17 Jul 2021 12:00 AM .
      </span>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>